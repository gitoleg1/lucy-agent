import json
from uuid import uuid4
from ..models.tasks import AuditLog, now_iso

def write_audit(
    session,
    task_id: str,
    event: str,
    data: dict | None = None,
    action_id: str | None = None,
    run_id: str | None = None,
    message: str | None = None,
) -> None:
    """
    כותב רשומת אודיט. שדות ה-DB:
    id, task_id, action_id, run_id, event_type (NOT NULL),
    message (NOT NULL), data_json (TEXT), created_at (TEXT/ISO).
    """
    rec = AuditLog(
        id=str(uuid4()),
        task_id=task_id,
        action_id=action_id,
        run_id=run_id,
        event_type=event,                  # שם העמודה ב-DB
        message=message or "",             # אסור None בעמודה NOT NULL
        data_json=json.dumps(data or {}),  # לשמור תמיד כמחרוזת JSON
        created_at=now_iso(),
    )
    session.add(rec)


def write_audit(session, task_id: str, event: str, data: dict | None = None,
                action_id: str | None = None, run_id: str | None = None,
                message: str | None = None):
    rec = AuditLog(
        id=str(uuid4()),
        task_id=task_id,
        action_id=action_id,
        run_id=run_id,
        event_type=event,                       # שם העמודה ב-DB
        message=message or "",                  # לא לשמור None
        data_json=json.dumps(data or {}),      # תמיד מחרוזת JSON
        created_at=now_iso(),
    )
    session.add(rec)
