      - name: Install deps (robust)
        shell: bash
        run: |
          set -euxo pipefail
          python -m venv .venv
          ./.venv/bin/python -m pip install --upgrade pip

          # דרישות הפרויקט (אם ריק/לא קיים לא מפילים את ה-CI)
          ( [ -f requirements.txt ] && ./.venv/bin/python -m pip install -r requirements.txt ) || true

          # תיקון קריסת greenlet בסביבת ubuntu-24.04 אם צריך (ייבוא תקין של importlib.metadata)
          ./.venv/bin/python - <<'PY'
          import sys, subprocess
          try:
              from importlib.metadata import version, PackageNotFoundError
          except Exception:
              # אם מסיבה כלשהי אין importlib.metadata, לא מפילים ריצה
              print("skip greenlet check: no importlib.metadata", file=sys.stderr)
              raise SystemExit(0)

          try:
              v = version("greenlet")
          except PackageNotFoundError:
              subprocess.check_call([sys.executable, "-m", "pip", "install", "greenlet==3.0.3"])
          else:
              if v.startswith(("3.1.", "3.2.")):
                  subprocess.check_call([sys.executable, "-m", "pip", "install", "--upgrade", "greenlet==3.0.3"])
          print("greenlet pin/check: OK")
          PY

          # מבטיחים FastAPI + Uvicorn זמינים
          ./.venv/bin/python -m pip install fastapi uvicorn
